ToDo по Stage 2D.
Пожалуйста, для КАЖДОГО пункта сначала: (1) проверь соответствие проекту и архитектуре, (2) задай вопросы, если что-то неочевидно, (3) предложи правки/варианты.
Только после моего подтверждения — выполняй изменения (patch/diff).

1. Валидация ID и notFound для /products/[id]

1.1. Найди текущий page для детальной страницы продукта (app/products/[id]/page.tsx или эквивалент).
1.2. Проверь, как сейчас парсится и используется id (Number(), parseInt и т.п).
1.3. Предложи и опиши утилиту/функцию валидации ID (например, isValidProductId), с учётом кейсов:

пустой id,

нечисловой (abc),

отрицательный,

0,

дробный,

слишком большой.
1.4. После моего подтверждения:

добавь валидацию ID на уровне page,

при невалидном ID вызывай notFound() из next/navigation,

не трогай внутрянку hooks/view-слоя, если это не обязательно.

Сделай краткий отчёт: какие файлы затронул, какие кейсы теперь покрыты.

2. Глобальная 404 и product-специфичная 404

2.1. Проверь, есть ли в проекте app/not-found.tsx и app/products/[id]/not-found.tsx.
2.2. Предложи минимальную реализацию этих компонентов, максимально используя текущие EmptyState / ErrorMessage из shared/ui (без новой heavy-вёрстки).
2.3. После моего подтверждения:

создай app/not-found.tsx — глобальная 404,

создай (или доработай) app/products/[id]/not-found.tsx — 404 для продукта,

убедись, что вызов notFound() из детальной страницы приводит к корректному UI.

Сделай краткий отчёт и укажи, какие сценарии теперь ведут к 404.

3. Global Error Boundary (app/error.tsx)

3.1. Проверь, есть ли уже app/error.tsx или кастомные ErrorBoundary-компоненты.
3.2. Предложи минимальную реализацию app/error.tsx, которая:

показывает понятное сообщение об ошибке,

даёт кнопку Try again, использующую reset,

не вносит тяжелых UI-изменений.
3.3. После моего подтверждения:

создай или доработай app/error.tsx,

убедись, что локальные ErrorMessage в widgets продолжают работать как раньше (ошибки данных ≠ глобальный краш).

Сделай краткий отчёт, как теперь выглядит поток при фатальной ошибке.

4. Улучшение safeLoadFromStorage / persist-слоя

4.1. Найди реализацию safeLoadFromStorage, persistMiddleware, createPreloadedState и другие LS-хелперы (в shared/lib или аналогичных местах).
4.2. Проанализируй, как сейчас обрабатываются:

некорректный JSON,

неожиданный тип (например, строка вместо массива),

отсутствие ключа.
4.3. Предложи минимальные улучшения:

безопасный try/catch вокруг JSON.parse,

возврат дефолтного значения/undefined без падения приложения,

опциональное console.warn в dev-режиме.
4.4. После моего подтверждения — внеси эти улучшения, не меняя публичный контракт функций.

Сделай краткий отчёт, какие edge-кейсы теперь безопасно обрабатываются.

5. Консистентность Error/Empty-состояний в widgets

5.1. Проверь использование ErrorMessage и EmptyState в:

widgets/products,

widgets/product-detail,

связанных hooks (useProductsView, useProductView).
5.2. Убедись, что:

бизнес-ошибки (нет данных, 404, скрытый продукт) не ломают всё приложение,

ошибки сети/серверов показываются через локальный ErrorMessage,

глобальные фатальные ошибки идут в app/error.tsx.
5.3. Если найдёшь дубли/несоглаcованность — предложи точечные улучшения (без больших рефакторингов UI).

После моего подтверждения — внеси минимальные исправления и опиши, что именно изменилось.

6. Итоговый отчёт по Stage 2D

6.1. После выполнения всех задач сформируй краткий итоговый отчёт:

какие файлы были изменены,

какие сценарии 404 теперь поддерживаются,

как работает глобальный Error Boundary,

какие edge-кейсы persist теперь безопасны.
6.2. Сохрани отчёт в docs/stage-2d-report.md (если файла нет — создай).

Если что-то в этих ToDo покажется тебе (Claude) сомнительным по отношению к текущему коду или архитектуре — сначала задать вопросы мне и предложить альтернативу, и только после моего явного согласия применять patch.

---

## ИЗВЕСТНЫЕ БАГИ (не исправлять в Stage 2D, запись для будущих стадий):

### Баг 1: Пагинация не сбрасывается при удалении продуктов

**Описание:**

- Если находишься на странице 3 из 3 (например, 21-30 продукты)
- Удаляешь локальный продукт, который находится на странице 3
- После удаления количество страниц уменьшается (например, становится 2 страницы)
- НО пагинация показывает "Page 3 of 2" и остаёшься на несуществующей странице
- Сбрасывается только при ручном переходе на существующую страницу

**Ожидаемое поведение:**

- При удалении продукта автоматически сбрасывать на последнюю валидную страницу (или на страницу 1)

**Затронутые файлы:**

- `features/pagination/model/paginationSlice.ts` — логика пагинации
- `widgets/products` — нужен side-effect при изменении totalPages

### Баг 2: EmptyState vs notFound() при удалении продукта на детальной странице

**Описание:**

- Если находишься на странице детали продукта (/products/[id])
- Удаляешь этот продукт
- Показывается `EmptyState` с "Product was removed" внутри виджета
- НО не вызывается `notFound()` → не показывается product-специфичная 404

**Текущее поведение:**

- `useProductView` возвращает `emptyState === "removed"`
- `ProductDetailWidget` рендерит `<EmptyState title="Product was removed" />`

**Возможное улучшение (обсудить):**

- Опция 1: Оставить как есть (EmptyState внутри виджета)
- Опция 2: Вызывать `notFound()` при `emptyState === "removed"` → показать product-специфичную 404
- Опция 3: Редирект на `/products` при удалении
